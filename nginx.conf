#nginx.conf
events {
    worker_connections 1024;
    # â†‘ æ¯ä¸ªå·¥ä½œè¿›ç¨‹æœ€å¤šåŒæ—¶å¤„ç† 1024 ä¸ªè¿æ¥
}

http {
    # ğŸ”§ å®šä¹‰ä¸Šæ¸¸æœåŠ¡å™¨ç»„
    upstream seckill_backend {
    # è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼šè½®è¯¢ï¼ˆé»˜è®¤ï¼‰
        server app1:8080;
        server app2:8080;
        server app3:8080;
    }

    # å…¶ä»–ç­–ç•¥é€‰é¡¹ï¼š
    # ip_hash;                      # åŒä¸€IPæ€»æ˜¯è®¿é—®åŒä¸€å°æœåŠ¡å™¨
    # least_conn;                   # é€‰æ‹©è¿æ¥æ•°æœ€å°‘çš„æœåŠ¡å™¨
    # server app1:8080 weight=3;    # æƒé‡åˆ†é…
}

# ğŸ”§ å…¨å±€é™æµï¼šä½¿ç”¨æ¼æ¡¶ç®—æ³•
limit_req_zone $binary_remote_addr zone=global_limit:10m rate=100r/s;
# â†‘ å®šä¹‰ä¸€ä¸ªé™æµåŒºåŸŸ
# $binary_remote_addr: æŒ‰å®¢æˆ·ç«¯ IP é™æµ
# zone=global_limit:10m: é™æµåŒºåŸŸåå« global_limitï¼Œå ç”¨ 10MB å†…å­˜
# rate=100r/s: æ¯ç§’æœ€å¤šå¤„ç† 100 ä¸ªè¯·æ±‚

server {
    # â†‘ å®šä¹‰ä¸€ä¸ªè™šæ‹ŸæœåŠ¡å™¨ï¼ˆå¤„ç† HTTP è¯·æ±‚çš„è§„åˆ™ï¼‰

    listen 80;
    server_name localhost;

    # ğŸ”§ å…¨å±€é™æµé…ç½®
    limit_req zone=global_limit burst=200 nodelay;
    # â†‘ åº”ç”¨åˆšæ‰å®šä¹‰çš„é™æµè§„åˆ™
    # burst=200: å…è®¸çªå‘ 200 ä¸ªè¯·æ±‚æ’é˜Ÿ
    # nodelay: ä¸å»¶è¿Ÿå¤„ç†ï¼Œè¶…è¿‡é™åˆ¶ç›´æ¥è¿”å› 503

    # æ—¥å¿—
    access_log /var/log/nginx/access.log;   # è®¿é—®æ—¥å¿—
    error_log /var/log/nginx/error.log;    # é”™è¯¯æ—¥å¿—

    # å¥åº·æ£€æŸ¥æ¥å£
    location /health {
        proxy_pass http://seckill_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ç§’æ€æ¥å£
    location /user/seckill {
        # é’ˆå¯¹ç§’æ€æ¥å£çš„é™æµ
        limit_req zone=global_limit burst=50 nodelay;
        
        proxy_pass http://seckill_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
        # è¶…æ—¶é…ç½®
        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;
    }

    # å…¶ä»–æ¥å£
    location / {
        proxy_pass http://seckill_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}